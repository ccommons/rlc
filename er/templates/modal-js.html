<script language="javascript">
function Modal() {
    $.extend(this, {
        'content_element' : null,
        'content_set' : function(content_html, id) {
            $('body').append(content_html);
            var content_id = "#" + id;
            this.content_element = $(content_id);
        },
        'content_delete' : function() {
            if (this.content_element !== null) {
                this.content_element.remove();
                this.content_element = null;
            }
        },
        'close' : function() {
            this.content_element.modal('hide');
        },
        'render' : function() {
            this.content_element.modal();
            this.content_element.on('hidden', this.content_delete.bind(this));
        }
    });
}

function AnnotationModal() {
    var $super = new Modal();
    $.extend(this, $super, {
        'render' : function() {
            $super.render.bind(this)();
            $('#annotation-compose').click(function(event) {
                this.close();
                annotation_compose_init({{ doc.id }});
            }.bind(this));
        }
    });
}

function modal_init(url, modaltype) {
    if (typeof(modaltype) === 'undefined') {
        var modaltype = Modal;
    }
    var display = function(data, status, jqxhr) {
        // TODO: add protocol error checking
        var modal = new modaltype();
        modal.content_set(data["body_html"], data["modal_id"]);
        modal.render();
    }
    $.get(url, '', display, 'json');
}

function annotation_init(doc_id, annotation_id) {
    // TODO: make this dynamic from URL
    var url = '/er/' + doc_id + '/annotation/openq/json';
    modal_init(url, AnnotationModal);
}

function annotation_compose_init(doc_id) {
    var url = '/er/' + doc_id + '/annotation/compose/openq/json';
    modal_init(url);
}
</script>

